# Implementation Plan

- **Conventions**
  - Property-based tests are marked with `*` and include a **Property N:** title plus a **Validates:** line.
  - Requirement references use the format `_Requirements: X.Y, X.Z_`.

- [x] 1. Implement the normative async endpoint contract (`POST /v1/notion/sprint-name/async`)
  - [x] 1.1 Ensure route wiring matches the normative contract and middleware ordering
    - Confirm `routes/v1/notion/index.js` mounts `POST /sprint-name/async` under `/v1/notion`
    - Ensure middleware order is: logging → auth → page id validation → seed validation → handler
    - Ensure responses are JSON via `res.json()` (both success and error)
    - Update `routes/v1/notion/index.js` as needed
    - _Requirements: 1.1, 5.1, 6.6_
  - [x] 1.2 Ensure async handler responds quickly with `202` and a non-empty `request_id`
    - Keep handler “accept only”: enqueue work and immediately return
    - Return `202` with `{ request_id: string }`
    - Ensure the handler does not await any Notion API calls
    - Update `routes/v1/notion/sprint-name-async.js`
    - _Requirements: 1.2, 1.3, 5.1_

- [ ] 2. Enforce authentication for Notion webhook calls
  - [ ] 2.1 Ensure auth middleware validates `X-Notion-Automations-Token` and returns `401` JSON errors
    - Validate missing header → `401 { error: string }`
    - Validate invalid token → `401 { error: string }`
    - Confirm case-insensitive header lookup (Express `req.get()` is case-insensitive)
    - Update `routes/v1/notion/middleware.js` if needed
    - _Requirements: 2.1, 2.2_
  - [ ] 2.2 Keep/extend auth property tests for missing/invalid token behavior
    - Ensure tests cover missing header, whitespace, and incorrect token cases
    - Update `routes/v1/notion/middleware.property.test.js`
    - _Requirements: 2.1, 2.2_

- [ ] 3. Validate and normalize `seed` and `page_id` (headers preferred, body fallback)
  - [x] 3.1 Implement normative seed precedence + regex validation (`^\d{4}_W\d{2}$`)
    - Prefer `X-Notion-Sprint-Seed` header; fallback to `body.seed` only when header is absent
    - Return `400 { error: string }` when missing seed
    - Return `400 { error: string }` when seed fails regex, and ensure the message indicates required format `YYYY_WNN`
    - Normalize validated seed into `req.body.seed` for downstream handlers
    - Update `routes/v1/notion/middleware.js` (`validateSprintNameRequest`)
    - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_
  - [x] 3.2 Implement normative page id precedence (header preferred) and required validation
    - Prefer `X-Notion-Page-Id` header; fallback to `body.page_id` (and other supported shapes) only when header is absent
    - Return `400 { error: string }` when page id is missing
    - Normalize page id to `req.notionPageId` for downstream handlers
    - Update `routes/v1/notion/middleware.js` (`validateNotionPageId` / `extractPageIdFromRequest`)
    - _Requirements: 4.1, 4.2, 4.3_
  - [x]* 3.3 **Property 1: Seed presence + format validation**
    - **Validates:** Requirements 3.2, 3.3, 3.4
    - Validate missing seed → `400 { error: string }`
    - Validate any non-matching seed → `400 { error: string }` mentioning `YYYY_WNN`
    - Update/add `routes/v1/notion/validation.property.test.js` (or a new property test file if clearer)
    - _Requirements: 3.2, 3.3, 3.4_
  - [x]* 3.4 **Property 2: Page id required**
    - **Validates:** Requirements 4.2
    - Validate missing page id across header/body shapes → `400 { error: string }`
    - Add `routes/v1/notion/page-id.property.test.js` (or extend an existing property test file)
    - _Requirements: 4.2_

- [x] 4. Implement bounded background queue behavior for async processing
  - [x] 4.1 Ensure enqueue is bounded and returns `429` when saturated
    - Keep a bounded pending counter and configurable max (`ASYNC_MAX_PENDING`, default `50`)
    - Ensure async handler returns `429 { error: string }` when queue is full
    - Update `lib/async-jobs.js` and `routes/v1/notion/sprint-name-async.js` as needed
    - _Requirements: 6.5_
  - [x] 4.2 Ensure background failures never block the webhook response and are logged with correlation identifiers
    - Ensure async job errors are caught
    - Log an error that includes `request_id` and `page_id` (best-effort) for Notion API failures
    - Consider passing context into `enqueueJob()` or wrapping the job function in the handler
    - Update `lib/async-jobs.js` and/or `routes/v1/notion/sprint-name-async.js`
    - _Requirements: 5.6_

- [x] 5. Update Notion page title via Notion API (correct payload + deterministic sprint title)
  - [x] 5.1 Compute `generated-slug` deterministically from `seed` and build Sprint Title as `Sprint <generated-slug> - <seed>`
    - Use `lib/name-generator.js` to compute `slug` deterministically from `seed`
    - Build Sprint Title exactly: `Sprint ${slug} - ${seed}`
    - Ensure repeated requests for same `seed` + `page_id` write the same title
    - Update `routes/v1/notion/sprint-name-async.js` (background job payload preparation)
    - _Requirements: 5.2, 5.3, 5.5_
  - [x] 5.2 Implement correct Notion “title property” payload for the configured title property
    - Add a helper for title properties (e.g. `buildTitleProperty(content)`) alongside `buildRichTextProperty`
    - Use the title property shape for `NOTION_SPRINT_NAME_PROPERTY` (default `Sprint Name`)
    - Keep optional extra properties (`NOTION_SPRINT_SLUG_PROPERTY`, `NOTION_SPRINT_GENERATOR_VERSION_PROPERTY`) as `rich_text` when configured
    - Update `lib/notion-api.js` and `routes/v1/notion/sprint-name-async.js`
    - _Requirements: 5.4, 6.4_
  - [x] 5.3 Ensure Notion API token/version configuration is enforced for async updates
    - Require `NOTION_API_TOKEN` to be present for the async endpoint (fail fast rather than silently accepting and failing later)
    - Ensure `NOTION_VERSION` is used with a safe default and can be configured
    - Update `config/env.js` and `routes/v1/notion/sprint-name-async.js`
    - _Requirements: 6.2, 6.3_
  - [x] 5.4 Ensure Notion API client emits useful errors for logging
    - Ensure failures include status + any JSON body (when present) to help debug permission/property issues
    - Update `lib/notion-api.js` (error shape/metadata as needed)
    - _Requirements: 5.6_

- [x] 6. Observability and operational safety checks
  - [x] 6.1 Ensure request-level logs include request id, endpoint, status, and latency
    - Confirm `lib/logging.js` middleware is applied to Notion routes
    - Ensure `request_id` can be used by the async handler (e.g. via `req.requestId`)
    - _Requirements: 6.6_
  - [x] 6.2 Ensure service startup enforces required configuration boundaries
    - Confirm `NOTION_AUTOMATIONS_TOKEN` is required at startup (via `config/env.js` usage)
    - Ensure the async endpoint additionally enforces `NOTION_API_TOKEN` presence
    - _Requirements: 6.1, 6.2_

- [ ] 7. Testing + performance smoke checks + documentation alignment
  - [x] 7.1 Add unit tests for the async endpoint response contract
    - Valid request → `202` with non-empty `request_id`
    - Queue full → `429 { error: string }`
    - Missing/invalid auth → `401 { error: string }`
    - Missing/invalid seed/page id → `400 { error: string }`
    - Add `routes/v1/notion/sprint-name-async.test.js`
    - _Requirements: 1.1, 1.3, 2.1, 2.2, 3.2, 3.4, 4.2, 6.5_
  - [x]* 7.2 **Property 3: Accept response has correct shape**
    - **Validates:** Requirements 1.1, 1.3
    - For any valid seed + page id and valid token, handler returns `202` and `{ request_id: non-empty string }`
    - Add `routes/v1/notion/sprint-name-async.property.test.js` (or extend existing property test files)
    - _Requirements: 1.1, 1.3_
  - [x]* 7.3 **Property 4: Deterministic title formatting**
    - **Validates:** Requirements 5.2, 5.3, 5.5
    - For any valid seed, the computed Sprint Title is exactly `Sprint <slug> - <seed>` (and stable across repeated runs)
    - Add `routes/v1/notion/sprint-name-async.property.test.js` (or extend existing property test files)
    - _Requirements: 5.2, 5.3, 5.5_
  - [x] 7.4 Update performance smoke script to reflect normative seed format and (optionally) async acceptance path
    - Update `scripts/notion-sprint-name-perf.js` seed examples to `YYYY_WNN` format
    - Add a basic “async accept” case if the script is extended to cover `/sprint-name/async`
    - _Requirements: 1.2, 3.3_
  - [x] 7.5 Ensure docs match the implementation details and defaults
    - Verify `docs/notion-sprint-name/design.md` matches actual payload shape (title vs rich_text) and seed format (`YYYY_WNN`)
    - Verify `docs/notion-sprint-name/requirements.md` contract is reflected in code + tests
    - _Requirements: 1.1, 3.3, 5.3, 5.4, 6.4_
